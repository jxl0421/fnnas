# CumeBox2 固件验证指南

## x86设备上能做的验证

### 1. 语法检查
可以在x86上验证以下文件的语法正确性：

#### Shell脚本语法检查
```bash
# 检查install.sh
bash -n custom/cumbox2/install.sh

# 检查所有脚本
bash -n custom/cumbox2/scripts/*.sh
```

#### Systemd服务文件语法检查
```bash
# 检查服务文件
systemd-analyze verify custom/cumbox2/systemd/*.service
```

#### 设备树语法检查
需要dtc（Device Tree Compiler）工具：
```bash
# 检查设备树补丁格式
dtc -I dts -O dtb custom/cumbox2/patch/cumbox2-startup.patch
```

### 2. 配置文件格式检查

#### uEnv.txt格式验证
- 确保每行都是 `key=value` 格式
- 检查启动地址格式：`kernel_addr=0x10800000`
- 检查没有多余空格或特殊字符

#### hardware.conf格式验证
- 确保所有配置项都有值
- 检查没有未闭合的引号
- 验证GPIO引脚命名正确

### 3. 文件完整性检查

```bash
# 检查所有必要文件是否存在
ls -la custom/cumbox2/config/
ls -la custom/cumbox2/scripts/
ls -la custom/cumbox2/systemd/
ls -la custom/cumbox2/patch/

# 检查文件权限（在Linux中）
find custom/cumbox2/scripts/ -name "*.sh" -exec chmod +x {} \;
```

## 需要在ARM设备或模拟器上测试的功能

### 1. QEMU ARM模拟器测试

使用QEMU模拟ARM设备（有限支持）：

```bash
# 安装QEMU ARM
sudo apt-get install qemu-system-arm qemu-efi-aarch64

# 创建虚拟磁盘
qemu-img create -f qcow2 disk.qcow2 8G

# 启动QEMU ARM
qemu-system-aarch64 \
  -M virt \
  -cpu cortex-a53 \
  -m 1G \
  -drive if=virtio,file=disk.qcow2,format=qcow2 \
  -kernel Image \
  -initrd uInitrd \
  -dtb meson-gxl-s905x-cumebox.dtb \
  -append "console=ttyAMA0,115200n8 root=/dev/vda rootwait ro rootfstype=ext4" \
  -nographic
```

**限制：**
- 无法模拟完整的Amlogic硬件（GPIO、I2C等外设）
- 需要自行准备ARM内核和设备树
- 仅用于验证基本启动流程

### 2. Docker容器测试（ARM架构）

使用Docker ARM镜像测试脚本：

```bash
# 拉取ARM镜像
docker pull --platform linux/arm64 ubuntu:latest

# 运行容器测试脚本
docker run --platform linux/arm64 -v $(pwd):/test ubuntu:latest bash /test/custom/cumbox2/scripts/oled_system_info.sh
```

**限制：**
- 无法测试硬件相关功能
- 仅能验证脚本逻辑

### 3. 实际硬件测试（推荐）

**必要的测试步骤：**

1. **启动测试**
   - 刷写固件到SD卡
   - 观察串口输出（如果可用）
   - 检查启动日志：`dmesg | grep -i "error\|fail"`

2. **硬件服务测试**
   ```bash
   # 检查OLED服务
   systemctl status cumbox2-oled
   journalctl -u cumbox2-oled -n 50

   # 检查风扇服务
   systemctl status cumbox2-fan
   journalctl -u cumbox2-fan -n 50

   # 检查按键服务
   systemctl status cumbox2-key
   journalctl -u cumbox2-key -n 50

   # 检查I2C设备
   i2cdetect -y 0

   # 检查GPIO
   cat /sys/kernel/debug/gpio
   ```

3. **功能测试**
   - OLED是否显示系统信息
   - 风扇是否随温度调节
   - LED是否正常工作
   - 按键是否响应

## GitHub Actions编译验证

推送代码后，GitHub Actions会自动编译固件，可以验证：
- 设备树补丁是否能正确应用
- 内核是否能成功编译
- 打包过程是否有错误

查看编译日志：
1. 访问你的GitHub仓库
2. 点击"Actions"标签
3. 查看编译任务的详细日志

## 推荐测试流程

### 开发阶段
1. ✅ 在x86上做语法检查
2. ✅ 推送代码，让GitHub Actions编译
3. ✅ 检查编译日志是否有错误

### 测试阶段
4. ⚠️ 下载编译好的固件
5. ⚠️ 在实际CumeBox2设备上测试
6. ⚠️ 检查所有硬件功能

## 常见问题

### Q: 为什么不能在x86上模拟？
A: ARM和x86是不同的CPU架构，需要二进制兼容的模拟环境，但无法模拟所有硬件特性。

### Q: 如何验证设备树补丁？
A: 可以使用dtc工具检查语法，但最终需要在实际硬件上验证硬件节点是否正确工作。

### Q: 一定要在真实设备上测试吗？
A: 是的，硬件相关的功能（OLED、风扇、GPIO等）必须在真实设备或ARM模拟器上测试。

### Q: GitHub Actions编译能发现问题吗？
A: 能发现编译和语法错误，但无法发现运行时错误。

## 总结

| 测试类型 | x86设备 | QEMU ARM | 真实设备 |
|---------|---------|----------|---------|
| 脚本语法 | ✅ | ✅ | ✅ |
| 配置格式 | ✅ | ✅ | ✅ |
| 内核启动 | ❌ | ⚠️ 有限 | ✅ |
| 硬件驱动 | ❌ | ❌ | ✅ |
| OLED显示 | ❌ | ❌ | ✅ |
| 风扇控制 | ❌ | ❌ | ✅ |
| GPIO操作 | ❌ | ❌ | ✅ |

**建议：在x86上做基础验证，然后在真实设备上做完整测试。**
