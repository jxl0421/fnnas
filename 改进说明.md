# CumeBox2 硬件适配改进说明

## 改进概述

针对CumeBox2硬件（1G内存、8GB存储）进行了全面优化，确保开机后硬件功能立即可用。

## 主要改进

### 1. 设备挂载规则（保持原项目兼容）

**改进前**：
- 使用自定义挂载规则
- 挂载点：/mnt/storage/{usb,sata,nvme}
- 与原项目不兼容

**改进后**：
- ✅ 使用标准udisks2自动挂载机制
- ✅ 挂载点：/media/（根据设备标签或UUID自动创建）
- ✅ 与原项目完全兼容
- ✅ 手动挂载命令：`udisksctl mount -b /dev/sdX1`

**优点**：
- 不需要自定义udev规则
- 支持桌面环境自动挂载
- 与标准Linux发行版一致
- 更稳定可靠

### 2. OLED显示服务（增强可靠性）

**改进**：
- ✅ 驱动加载检测和重试机制
- ✅ I2C设备自动检测
- ✅ framebuffer设备等待
- ✅ 网络连接等待
- ✅ 详细的启动日志

**服务特性**：
- 启动失败后10秒自动重试
- 始终重启（Restart=always）
- 详细的日志输出
- 错误自动恢复

**确保开机能用**：
1. 首次加载失败自动重试
2. I2C设备检测确认硬件存在
3. 等待系统和网络就绪
4. 2秒刷新间隔保证实时显示

### 3. 风扇控制服务（增强可靠性）

**改进**：
- ✅ GPIO编号智能解析（支持AO_X、X_XX格式）
- ✅ GPIO初始化检测和重试
- ✅ 多种温度传感器支持
- ✅ 详细的状态日志
- ✅ 防止重复开关

**服务特性**：
- 启动失败后10秒自动重试
- 始终重启（Restart=always）
- 详细的日志输出
- GPIO错误检测和报告

**确保开机能用**：
1. 首次初始化失败自动重试
2. GPIO状态检查
3. 温度传感器检测
4. 防止频繁开关
5. 启动前等待系统稳定

### 4. 按键服务（增强可靠性）

**改进**：
- ✅ 自动重试机制
- ✅ 详细日志输出
- ✅ 标准化配置

**服务特性**：
- 启动失败后10秒自动重试
- 始终重启（Restart=always）
- 详细的日志输出

### 5. 系统优化配置

**针对1G内存、8GB存储优化**：

**内存优化**：
- Swap：2GB（内存的2倍）
- ZRAM：512MB压缩内存
- swappiness：10（减少swap使用）

**存储优化**：
- 根分区：8GB（默认）
- 外挂设备：标准udisks2自动挂载
- 日志优化：限制大小和数量

**系统优化**：
- 禁用不必要的服务
- 禁用透明大页
- 优化I/O调度器
- 优化内核参数

### 6. 服务检查工具

新增服务状态检查脚本：
```bash
/usr/local/cumbox2/scripts/check_services.sh
```

**检查内容**：
- 所有硬件服务状态和日志
- 内存和Swap状态
- 外挂设备挂载状态
- I2C设备检测
- GPIO导出状态

## 服务启动流程

### 开机启动顺序

1. **系统启动**
   - 内核加载
   - 基础系统服务启动

2. **安装脚本执行**（首次启动）
   - 创建目录和配置
   - 安装依赖包
   - 配置Swap和ZRAM
   - 启用systemd服务

3. **硬件服务启动**
   - OLED服务：加载驱动 → 等待网络 → 开始显示
   - 风扇服务：初始化GPIO → 等待稳定 → 温度监控
   - 按键服务：监听按键事件

4. **自动重试机制**
   - 任何服务启动失败
   - 10秒后自动重试
   - 持续重试直到成功

### 确保开机可用的措施

1. **启动延迟**：等待系统和依赖服务完全就绪
2. **设备检测**：确认硬件存在再启动服务
3. **错误重试**：自动重试机制，无需手动干预
4. **详细日志**：方便排查问题
5. **状态检查**：提供检查工具确认状态

## 使用说明

### 首次启动

1. 刷写固件到TF卡/U盘
2. 插入CumeBox2开机
3. 系统自动启动并执行优化
4. 硬件服务自动启动（可能需要1-2分钟）

### 检查服务状态

```bash
# 运行检查脚本
/usr/local/cumbox2/scripts/check_services.sh

# 或单独查看服务状态
systemctl status cumbox2-oled
systemctl status cumbox2-fan
systemctl status cumbox2-key
```

### 查看服务日志

```bash
# 查看所有硬件服务日志
journalctl -u cumbox2-* -f

# 查看单个服务日志
journalctl -u cumbox2-oled -f
journalctl -u cumbox2-fan -f
```

### 手动重启服务

```bash
# 重启OLED服务
systemctl restart cumbox2-oled

# 重启风扇服务
systemctl restart cumbox2-fan

# 重启按键服务
systemctl restart cumbox2-key
```

## 故障排查

### OLED不显示

1. **检查服务状态**：
   ```bash
   systemctl status cumbox2-oled
   ```

2. **查看日志**：
   ```bash
   journalctl -u cumbox2-oled -n 50
   ```

3. **检查I2C设备**：
   ```bash
   i2cdetect -y 0
   ```

4. **服务会自动重试**，等待1-2分钟

### 风扇不转动

1. **检查服务状态**：
   ```bash
   systemctl status cumbox2-fan
   ```

2. **查看日志**：
   ```bash
   journalctl -u cumbox2-fan -n 50
   ```

3. **检查GPIO配置**：
   - 确认`/etc/cumbox2/hardware.conf`中`FAN_GPIO`配置正确
   - GPIO格式：AO_3 或 X_49

4. **检查温度**：
   ```bash
   cat /sys/class/thermal/thermal_zone0/temp
   ```
   温度需要超过50℃风扇才会开启

### 外挂设备不挂载

1. **使用标准方式挂载**：
   ```bash
   # 图形界面
   udiskie --tray --automount --notify

   # 命令行
   udisksctl mount -b /dev/sdX1
   ```

2. **查看挂载点**：
   ```bash
   df -h | grep /media
   ```

## 总结

通过以上改进，CumeBox2硬件适配具有以下特点：

✅ **兼容性**：设备挂载使用标准udisks2，与原项目兼容
✅ **可靠性**：所有硬件服务支持自动重试，确保开机可用
✅ **可维护性**：提供详细的日志和检查工具
✅ **优化性**：针对1G内存、8GB存储专门优化
✅ **易用性**：自动化程度高，无需手动干预

**预期效果**：
- 开机后1-2分钟内，OLED显示系统信息
- 风扇根据温度自动调节（超过50℃开启）
- 外挂设备自动挂载到/media/
- 内存充足（物理1GB + Swap 2GB + ZRAM 512MB≈4-4.5GB）
- 系统稳定流畅